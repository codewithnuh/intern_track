generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---

enum Role {
  INTERN
  ADMIN
  MENTOR
  HR
}

enum UserStatus {
  PENDING_ONBOARDING
  PENDING_APPROVAL
  ACTIVE
  REJECTED
  SUSPENDED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  COMPLETED
}

// --- 1. CORE IDENTITY ---

model User {
  id        String     @id @default(uuid())
  clerkId   String     @unique
  name      String
  email     String     @unique
  role      Role       @default(INTERN)
  status    UserStatus @default(PENDING_ONBOARDING) // Your HR workflow starts here

  intern    Intern?
  mentor    Mentor?

  auditLogs     AuditLog[]
  feedbacksGiven Feedback[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}



model Intern {
  id         String   @id @map("user_id")
  user       User     @relation(fields: [id], references: [id], onDelete: Cascade)
  university String

  mentorId   String?
  mentor     Mentor?  @relation(fields: [mentorId], references: [id], onDelete: SetNull)

  // Connections
  projects      ProjectAssignment[]
  tasks         Task[]
  attendance    Attendance[]
  feedback      Feedback[]
  leaveRequests LeaveRequest[]

  updatedAt DateTime @updatedAt
}

model Mentor {
  id           String     @id @map("user_id")
  user         User       @relation(fields: [id], references: [id], onDelete: Cascade)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  interns      Intern[]
  updatedAt    DateTime   @updatedAt
}

// --- 3. PROJECT MANAGEMENT ---

model Department {
  id       String    @id @default(uuid())
  name     String    @unique
  projects Project[]
  mentors  Mentor[]
}

model Project {
  id           String              @id @default(uuid())
  name         String
  description  String?
  departmentId String
  department   Department          @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  tasks        Task[]
  interns      ProjectAssignment[]

  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
}

model ProjectAssignment {
  internId   String
  projectId  String
  assignedAt DateTime @default(now())

  intern     Intern   @relation(fields: [internId], references: [id], onDelete: Cascade)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@id([internId, projectId])
}

model Task {
  id         String     @id @default(uuid())
  title      String
  status     TaskStatus @default(TODO)

  projectId  String
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assigneeId String
  assignee   Intern     @relation(fields: [assigneeId], references: [id], onDelete: Cascade)

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

// --- 4. ANALYTICS, LEAVE & LOGS ---

model Attendance {
  id       String    @id @default(uuid())
  checkIn  DateTime  @default(now())
  checkOut DateTime?

  internId String
  intern   Intern    @relation(fields: [internId], references: [id], onDelete: Cascade)
}

model Feedback {
  id         String   @id @default(uuid())
  content    String
  rating     Int      // 1-5

  internId   String
  intern     Intern   @relation(fields: [internId], references: [id], onDelete: Cascade)

  // Fixed: Enforced relation for reviewer
  reviewerId String
  reviewer   User     @relation(fields: [reviewerId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model LeaveRequest {
  id        String         @id @default(uuid())
  internId  String
  intern    Intern         @relation(fields: [internId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  reason    String
  status    ApprovalStatus @default(PENDING)

  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id]) // Enforced relation

  action    String
  entity    String
  entityId  String

  createdAt DateTime @default(now())
}
